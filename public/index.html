<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat con Socket.IO</title>
</head>
<body>
    <div id="container" role="main">
        <header>
            <h1>Chat con Socket.IO</h1>
        </header>

        <section id="usernameForm" aria-live="polite">
            <label for="usernameInput">Ingresa tu nombre de usuario:</label>
            <input type="text" id="usernameInput" autocomplete="off" aria-labelledby="usernameLabel" />
            <button id="setUsernameButton" aria-describedby="usernameError">Ingresar al Chat</button>
            <p id="usernameError" style="color: red;" role="alert"></p>
        </section>

        <section id="chat" style="display:none;">
            <div class="cabecera">Usuarios Conectados</div>
            <ul id="usuariosConectados"></ul>
            <div class="cabecera">Zona de Chat</div>
            <ul id="messages" aria-live="polite"></ul>

            <form id="form">
                <label for="input">Escribe un mensaje:</label>
                <input id="input" autocomplete="off" placeholder="Escribe un mensaje..." aria-labelledby="inputLabel" />
                <label for="destinatario">Nombre del destinatario (opcional):</label>
                <input id="destinatario" placeholder="Nombre del destinatario (opcional)" aria-labelledby="destinatarioLabel" />
                <button>Enviar</button>
            </form>
        </section>

        <footer>
            <p>© 2024 Chat con Socket.IO. Todos los derechos reservados.</p>
        </footer>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>
        $(function () {
            var socket = io();

            function scrollToBottom() {
                var messagesContainer = $('#messages');
                messagesContainer.scrollTop(messagesContainer.prop("scrollHeight"));
            }

            // Mostrar el formulario de nombre de usuario
            $('#usernameForm').show();
            $('#chat').hide();

            // Evento al hacer clic en el botón de establecer nombre de usuario
            $('#setUsernameButton').click(function() {
                var username = $('#usernameInput').val().trim();

                // Validar que el nombre de usuario no esté vacío
                if (username === '') {
                    $('#usernameError').text('Por favor, ingresa un nombre de usuario.');
                    return;
                }

                // Enviar el nombre de usuario al servidor
                socket.emit('set username', username);
            });

            // Manejar la respuesta del servidor sobre la validez del nombre de usuario
            socket.on('username valid', function() {
                // Ocultar el formulario de nombre de usuario y mostrar el chat
                $('#usernameError').text(''); // Limpiar mensaje de error
                $('#usernameForm').hide();
                $('#chat').show();
            });

            // Manejar el evento de nombre de usuario existente
            socket.on('nombre de usuario existente', function() {
                $('#usernameError').text('Este nombre de usuario ya está en uso. Por favor, elige otro.');
            });

            // Resto del código del cliente...

            $('form').submit(function(e) {
                e.preventDefault();
                var message = $('#input').val();
                var destinatario = $('#destinatario').val();

                if (destinatario) {
                    // Verificar si el destinatario existe antes de enviar el mensaje privado
                    var destinatarioExiste = $('#usuariosConectados li:contains(' + destinatario + ')').length > 0;

                    if (destinatarioExiste) {
                        socket.emit('private message', { msg: message, to: destinatario });
                    } else {
                        // Mostrar mensaje de error en el área de chat
                        var liError = $('<li>').text('El usuario "' + destinatario + '" no existe.');
                        $('#messages').append(liError);
                        scrollToBottom(); // Hacer scroll al último mensaje
                        return;
                    }
                } else {
                    socket.emit('chat message', message);
                }

                $('#input').val('');
                scrollToBottom(); // Hacer scroll al último mensaje
                return false;
            });

            socket.on('chat message', function(data){
                var li = $('<li>').text(data.from + ' dice: ' + data.msg);
                $('#messages').append(li);
                scrollToBottom(); // Hacer scroll al último mensaje
            });

            socket.on('private message', function(data){
                var isSender = data.from === $('#usernameInput').val();
                var isRecipient = data.to === $('#usernameInput').val();

                // Mostrar mensajes privados solo si el usuario es el remitente o el destinatario
                if (isSender || isRecipient) {
                    var li = $('<li>').text(data.from + ' (privado) dice: ' + data.msg);
                    $('#messages').append(li);
                    scrollToBottom(); // Hacer scroll al último mensaje
                }
            });

            socket.on('usuarios conectados', function(usuarios){
                $('#usuariosConectados').empty();
                usuarios.forEach(function(name){
                    var li = $('<li>').text(name);
                    $('#usuariosConectados').append(li);
                });
            });
        });
    </script>
</body>
</html>
